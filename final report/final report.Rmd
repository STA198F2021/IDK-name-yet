---
title: "Final Report"
author: "Maya Ghanem and Isabelle Xiong"
date: "11/15/2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, echo= FALSE, warning= FALSE, message= FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-data-packages, echo= FALSE, warning= FALSE, message= FALSE}
library(readr)
library(tidyverse)
library(readxl)
library(dplyr)
library(tidymodels)
library(patchwork)
library(plotly)
library(widgetframe)
library(here)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)
library(patchwork)
library(ggpubr)
```

```{r upload-insurance-data, echo= FALSE, message= FALSE, warning= FALSE}
insurance <- read_excel(here("data/insurance_500_cities.xlsx"))
```

```{r upload-visits-to-doctor-data, echo= FALSE, message= FALSE, warning= FALSE}
visits_to_doctor <- read_excel(here("data/visits_to_doctor.xlsx"))
```

```{r upload-medicine-high-bp-data, echo= FALSE, message= FALSE, warning= FALSE}
medicine_high_bp <- read_excel(here("data/medicine_high_bp.xlsx"))
```

```{r upload-smoking-data, echo= FALSE, message= FALSE, warning= FALSE}
smoking <- read_excel(here("data/smoking.xlsx"))
```

```{r upload-binge-drinking-data, echo= FALSE, message= FALSE, warning= FALSE}
binge_drinking <- read_excel(here("data/binge_drinking.xlsx"))
```

```{r upload-physical-activity-data, echo= FALSE, message= FALSE, warning= FALSE}
physical_activity <- read_excel(here("data/physical_activity.xlsx"))
```

```{r upload-heart-disease-data, echo= FALSE, message= FALSE, warning= FALSE}
heart_disease <- read_excel(here("data/heart_disease.xlsx"))
```

```{r upload-diabetes-data, echo= FALSE, message=FALSE, warning= FALSE}
diabetes <- read_excel(here("data/diabetes.xlsx"))
```

```{r upload-kidney-disease-data, echo= FALSE, message= FALSE, warning= FALSE}
kidney_disease <- read_excel(here("data/kidney_disease.xlsx"))
```

```{r edit-insurance-data, echo= FALSE, message= FALSE, warning= FALSE}
edit_insurance <- insurance %>%
  select(StateAbbr, StateDesc, CityName, Data_Value_Type, Data_Value, GeoLocation) %>%
  filter(Data_Value_Type %in% c("Age-adjusted prevalence")) %>%
  group_by(CityName) %>%
  mutate(mean_value = mean(Data_Value)) %>%
  select(StateAbbr, StateDesc, CityName, mean_value, GeoLocation) %>%
  distinct(CityName, .keep_all = TRUE) %>%
  rename("insurance" = mean_value)
```

```{r edit-visits-to-doctor-data, echo= FALSE, message= FALSE, warning= FALSE}
edit_visits_to_doctor <- visits_to_doctor %>%
  select(StateAbbr, StateDesc, CityName, Data_Value_Type, Data_Value, GeoLocation) %>%
  filter(Data_Value_Type %in% c("Age-adjusted prevalence")) %>%
  group_by(CityName) %>%
  mutate(mean_value = mean(Data_Value)) %>%
  select(StateAbbr, StateDesc, CityName, mean_value, GeoLocation) %>%
  distinct(CityName, .keep_all = TRUE) %>%
  rename("visits_to_doctor" = mean_value)
```

```{r edit-medicine-high-bp-data, echo= FALSE, message= FALSE, warning= FALSE}
edit_medicine_high_bp <- medicine_high_bp %>%
  select(StateAbbr, StateDesc, CityName, Data_Value_Type, Data_Value, GeoLocation) %>%
  filter(Data_Value_Type %in% c("Age-adjusted prevalence")) %>%
  group_by(CityName) %>%
  mutate(mean_value = mean(Data_Value)) %>%
  select(StateAbbr, StateDesc, CityName, mean_value, GeoLocation) %>%
  distinct(CityName, .keep_all = TRUE) %>%
  rename("medicine_high_bp" = mean_value)
```

```{r edit-smoking-data, echo= FALSE, message= FALSE, warning= FALSE}
edit_smoking <- smoking %>%
  select(StateAbbr, StateDesc, CityName, Data_Value_Type, Data_Value, GeoLocation) %>%
  filter(Data_Value_Type %in% c("Age-adjusted prevalence")) %>%
  group_by(CityName) %>%
  mutate(mean_value = mean(Data_Value)) %>%
  select(StateAbbr, StateDesc, CityName, mean_value, GeoLocation) %>%
  distinct(CityName, .keep_all = TRUE) %>%
  rename("smoking" = mean_value)
```

```{r edit-binge-drinking-data, echo= FALSE, message= FALSE, warning= FALSE}
edit_binge_drinking <- binge_drinking %>%
  select(StateAbbr, StateDesc, CityName, Data_Value_Type, Data_Value, GeoLocation) %>%
  filter(Data_Value_Type %in% c("Age-adjusted prevalence")) %>%
  group_by(CityName) %>%
  mutate(mean_value = mean(Data_Value)) %>%
  select(StateAbbr, StateDesc, CityName, mean_value, GeoLocation) %>%
  distinct(CityName, .keep_all = TRUE) %>%
  rename("binge_drinking" = mean_value)
```

```{r edit-physical-activity, echo= FALSE, message= FALSE, warning= FALSE}
edit_physical_activity <- physical_activity %>%
  select(StateAbbr, StateDesc, CityName, Data_Value_Type, Data_Value, GeoLocation) %>%
  filter(Data_Value_Type %in% c("Age-adjusted prevalence")) %>%
  group_by(CityName) %>%
  mutate(mean_value = mean(Data_Value)) %>%
  select(StateAbbr, StateDesc, CityName, mean_value, GeoLocation) %>%
  distinct(CityName, .keep_all = TRUE) %>%
  rename("physical_activity" = mean_value)
```

```{r edit-heart-disease-data, echo= FALSE, message= FALSE, warning= FALSE}
edit_heart_disease <- heart_disease %>%
  select(StateAbbr, StateDesc, CityName, Data_Value_Type, Data_Value, GeoLocation) %>%
  filter(Data_Value_Type %in% c("Age-adjusted prevalence")) %>%
  group_by(CityName) %>%
  mutate(mean_value = mean(Data_Value)) %>%
  select(StateAbbr, StateDesc, CityName, mean_value, GeoLocation) %>%
  distinct(CityName, .keep_all = TRUE) %>%
  rename("heart_disease" = mean_value)
```

```{r edit-diabetes-data, echo= FALSE, message= FALSE, warning= FALSE}
edit_diabetes <- diabetes %>%
  select(StateAbbr, StateDesc, CityName, Data_Value_Type, Data_Value, GeoLocation) %>%
  filter(Data_Value_Type %in% c("Age-adjusted prevalence")) %>%
  group_by(CityName) %>%
  mutate(mean_value = mean(Data_Value)) %>%
  select(StateAbbr, StateDesc, CityName, mean_value, GeoLocation) %>%
  distinct(CityName, .keep_all = TRUE) %>%
  rename("diabetes" = mean_value)
```

```{r edit-kidney-disease-data, echo= FALSE, message= FALSE, warning= FALSE}
edit_kidney_disease <- kidney_disease %>%
  select(StateAbbr, StateDesc, CityName, Data_Value_Type, Data_Value, GeoLocation) %>%
  filter(Data_Value_Type %in% c("Age-adjusted prevalence")) %>%
  group_by(CityName) %>%
  mutate(mean_value = mean(Data_Value)) %>%
  select(StateAbbr, StateDesc, CityName, mean_value, GeoLocation) %>%
  distinct(CityName, .keep_all = TRUE) %>%
  rename("kidney_disease" = mean_value)
```

```{r join-data, echo= FALSE, warning= FALSE, message= FALSE}
data_500_cities <- edit_insurance %>%
  left_join(edit_visits_to_doctor) %>%
  left_join(edit_medicine_high_bp) %>%
  left_join(edit_smoking) %>%
  left_join(edit_binge_drinking) %>%
  left_join(edit_physical_activity) %>%
  left_join(edit_heart_disease) %>%
  left_join(edit_diabetes) %>%
  left_join(edit_kidney_disease) %>%
  select(c(StateAbbr, StateDesc, CityName, insurance, visits_to_doctor, medicine_high_bp, smoking, binge_drinking, physical_activity, heart_disease, diabetes, kidney_disease, GeoLocation))
```

```{r map-vis, echo= FALSE, warning= FALSE, message= FALSE, include= FALSE}
theme_set(theme_bw())
world <- ne_countries(scale = "medium", returnclass = "sf")
names(world)
state.name
```

``` {r states-desc, echo= FALSE, warning= FALSE, message= FALSE}
states <- map_data("state")
states %>%
  mutate(StateDesc = str_to_title(region)) -> states
```

```{r filter-ANOVA, echo= FALSE, warning= FALSE, message= FALSE}
ANOVA_data_500_cities <- data_500_cities %>%
  filter(StateDesc %in% c("Arizona", "California", "Colorado", "Florida", "Georgia", "Illinois", "Indiana", "Massachusetts", "Michigan", "North Carolina", "Texas", "Virginia", "Washington")) %>%
  mutate(linsruance = log(insurance)) %>%
  mutate(lvisits_to_doctor = log(visits_to_doctor)) %>%
  mutate(lmedicine_high_bp = log(medicine_high_bp)) %>%
  mutate(lheart_disease = log(heart_disease)) %>%
  mutate(ldiabetes = log(diabetes)) %>%
  mutate(lkidney_disease = log(kidney_disease))
```

```{r load-map-data, echo= FALSE, message= FALSE, warning= FALSE}
map_ANOVA_data_500_cities <- ANOVA_data_500_cities %>%
  group_by(StateDesc) %>%
  mutate(insurancemean = mean(insurance)) %>%
  mutate(visits_to_doctormean = mean(visits_to_doctor)) %>%
  mutate(lmedicine_high_bpmean = mean(lmedicine_high_bp)) %>%
  mutate(lheart_diseasemean = mean(lheart_disease))

map_data <- map_ANOVA_data_500_cities %>% 
  left_join(states, by = "StateDesc")
```

# Background and Significance

America, unlike other developed countries, does not have a universal healthcare program, meaning that not all individuals are granted free health insurance by the government. In America, Health insurance is purchased in the private marketplace or provided by the government only to certain groups, such as pregnant, low income, elderly, families with children.

The members of this project have personal experiences with United States health insurance. Having lived in Canada, where all citizens can apply for a public health insurance for free which grants them access to quality healthcare, Isabelle has never had to think of what it would be like without access to healthcare. In doing this research, Isabelle wanted to understand the effects of a lack of health insurance in the US, by finding the correlation between not having health insurance and the likelihood of contracting different diseases in 500 largest US cities. Maya worked at Westminster Free Clinic for four years, which offered healthcare services to the uninsured population in Ventura County, California. They witnessed how the obstacles our patients faced in accessing healthcare impacted their behaviors and healthcare outcomes. 

# Data Collection and Variables

The 500 cities dataset is provided by the Center for Disease Control and Prevention (CDC), Division of Population Health, Epidemiology and Surveillance Branch. Data from this dataset is sourced from 28,000 census tracts in “Census Bureau 2010 census population data, Behavioral Risk Factor Surveillance System (BRFSS) data (2017, 2016), and American Community Survey (ACS) 2013-2017, 2012-2016 estimates”. All data was collected through the form of surveys. The meta dataset features data for a total of 5 “unhealthy behaviors”, 13 “health outcomes'' and 9 “preventive services” related to 27 types of chronic disease in 500 largest cities in the US. Within the datasets for diabetes, coronary heart disease, mental health outcomes and health insurance, variables include city, state, state abbreviation, year, datasource, TractFIPS, CityFIPS, Geographic Level, data value, low confidence unit, high confidence unit, coordinate of geographical location of city. 

The original dataset includes about 29,000 observations, with multiple measurements for each city based on the data source (census, BRFSS, ACS). We restricted our dataset to only include variables on percent of city with lack of insurance, visiting the doctor, taking high blood pressure medications, smoking, reporting binge drinking, not having physical activity, with heart disease, with diabetes, and with kidney disease. We took the mean of all the age-adjusted prevalence measurements within a city and filtered our dataset to these means. As a result, there was only one measurement per city. For ANOVA testing, we filtered our dataset to only include states with measurements for at least 10 cities and created logarithmic versions of all variables.

# Research Questions

1) Do cities with a greater lack of healthcare access have poorer mental health and/or physical health outcomes? 

2) Does healthcare access, mental health, and/or physical health outcomes vary by state?

# Variables of Interest

1) Healthcare Access for Adults (18+): Percent of City Population that Lacks Insurance, Percent of City Population with visits to doctor for routine checkup within the past year, Percent of City Population who have high blood pressure and are taking medicine for high blood pressure control.

2) Geographic Distribution by State

3) Behavior for Adults (18+): Percent of city population currently smoking, percent of city population currently reporting binge drinking habits, percent of city population reporting No leisure-time physical activity

4) Health Outcomes for Adults (18+): Percent of city population with coronary heart disease, percent of population diagnosed with diabetes, percent of city population with kidney disease 

For Research Question 1, Healthcare Access Variables (1) are the explanatory variables, whereas Behavior (3) and Health Outcomes (4) are the response variables. For Research Question 2, Geographic Distribution by State (2) is the explanatory variable, and all health indicators (1, 3, 4) are the response variables.

# Exploratory Data Analysis

## Research Question 1

The following visuals are scatter plots between the insurance (the main explanatory variable we want to focus on) and a behavior or health outcome variable.

```{r exploratory-scatterplots, warning= FALSE, message= FALSE, echo= FALSE}
plot1 <- data_500_cities %>%
  ggplot(mapping = aes(x = insurance, y = smoking)) +
  geom_point() +
  labs(
    title = "vs. % Adults Smoking",
    subtitle = "where each datapoint represents a city",
    x = "% Lack Insurance",
    y = "% Adults Smoking"
  )

plot2 <- data_500_cities %>%
  ggplot(mapping = aes(x = insurance, y = binge_drinking)) +
  geom_point() +
  labs(
    title = "vs. % Adults Binge Drinking",
    subtitle = "where each datapoint represents a city",
    x = "% Lack Insurance",
    y = "% Binge Drinking"
  )

plot3 <- data_500_cities %>%
  ggplot(mapping = aes(x = insurance, y = medicine_high_bp)) +
  geom_point() +
  labs(
    title = "vs. % Taking BP Meds",
    subtitle = "where each datapoint represents a city",
    x = "% Lack Insurance",
    y = "% Taking High BP Meds"
  )

plot4 <- data_500_cities %>%
  ggplot(mapping = aes(x = insurance, y = heart_disease)) +
  geom_point() +
  labs(
    title = "vs. % with Heart Disease",
    subtitle = "where each datapoint represents a city",
    x = "% Lack Insurance",
    y = "% with Heart Disease"
  )

plot5 <- data_500_cities %>%
  ggplot(mapping = aes(x = insurance, y = diabetes)) +
  geom_point() +
  labs(
    title = "vs. % with Diabetes",
    subtitle = "where each datapoint represents a city",
    x = "% Lack Insurance",
    y = "% with Diabetes"
  )

plot6 <- data_500_cities %>%
  ggplot(mapping = aes(x = insurance, y = kidney_disease)) +
  geom_point() +
  labs(
    title = "vs. % with Kidney Disease",
    subtitle = "where each datapoint represents a city",
    x = "% Lack Insurance",
    y = "% Kidney Disease"
  )
```

Figure 1: % Lacking Insurance vs. Behavior and Health Outcome Variables
```{r ggarrange-scatterplots, echo= FALSE, message= FALSE, warning= FALSE, fig.width = 10, fig.height = 3}
ggarrange(plot1, plot2, plot3, plot4, plot5, plot6, row = 2, ncol = 3) %>%
  print()
```

## Research Question 2

The maps below visualize the distribution healthcare access, behavior, and outcome variables by state. Only states that have at least ten observations are included, and only four variables that fit the assumptions for ANOVA testing.

```{r state-map-insruance, echo= FALSE, message= FALSE, warning= FALSE, fig.height= 3, fig.width= 5}
map1 <- ggplot(data = map_data, aes(x = long, y = lat, group = group, fill = insurancemean)) + 
  geom_polygon(color = "white")+
    labs(
       fill = "Percent No 
Insurance",
       title = "Mean % No Health Insurance",
subtitle = "Data Retreived from CDC 500 Cities")
```

```{r state-map-visits_to_doctor, echo= FALSE, message= FALSE, warning= FALSE, fig.height= 3, fig.width= 5}
map2 <- ggplot(data = map_data, aes(x = long, y = lat, group = group, fill = visits_to_doctormean)) + 
  geom_polygon(color = "white")+
    labs(
       fill = "% Visits 
to Doctor",
       title = "Mean % Pop Visiting Doctor",
subtitle = "Data Retreived from CDC 500 Cities")
```

```{r state-map-lhigh-bp-meds, echo= FALSE, message= FALSE, warning= FALSE, fig.height= 3, fig.width= 5}
map3 <- ggplot(data = map_data, aes(x = long, y = lat, group = group, fill = lmedicine_high_bpmean)) + 
  geom_polygon(color = "white")+
    labs(
       fill = "Log Percent Taking 
High BP Meds",
       title = "Mean Log % Taking High BP Meds",
subtitle = "Data Retreived from CDC 500 Cities")
```

```{r state-map-lheart-disease, echo= FALSE, message= FALSE, warning= FALSE, fig.height= 3, fig.width= 5}
map4 <- ggplot(data = map_data, aes(x = long, y = lat, group = group, fill = lheart_diseasemean)) + 
  geom_polygon(color = "white")+
    labs(
       fill = "Log Percent with 
Heart Disease",
       title = "Mean Log % with Heart Disease",
subtitle = "Data Retreived from CDC 500 Cities")
```

Figure 2: State Distribution of Healhcare Access, Behavior, and Health Outcome Variables
```{r ggarrange-maps, echo= FALSE, message= FALSE, warning= FALSE, fig.height= 3, fig.width = 10}
ggarrange(map1, map2, map3, map4, row = 2, ncol = 2) %>%
  print()
```